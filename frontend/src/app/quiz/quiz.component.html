<section class="quiz">
  <h3>{{ selectedQuiz?.title || 'Bài kiểm tra (4 phần)' }}</h3>
  <form (ngSubmit)="onSubmit($event)">
    <ng-container *ngFor="let section of quizSections">
      <div class="quiz-section">
        <h4>{{ section.title }}</h4>
        <div *ngFor="let q of section.questions" class="question">
          <div class="question-header">
            <p class="q-text">
              <span class="question-index">{{ q.id }}.</span>
              <span *ngIf="shouldShowPrompt(q)"> {{ q.prompt }}</span>
              <span *ngIf="!shouldShowPrompt(q) && isListeningQuestion(q)" class="placeholder">[Đang ẩn nội dung câu hỏi]</span>
            </p>
            <div class="question-controls" *ngIf="isListeningQuestion(q)">
              <button type="button" class="toggle-btn" (click)="togglePrompt(q.id)">
                {{ shouldShowPrompt(q) ? 'Ẩn câu hỏi' : 'Hiện câu hỏi' }}
              </button>
              <button type="button" class="toggle-btn" (click)="toggleAnswers(q.id)">
                {{ shouldShowAnswers(q) ? 'Ẩn đáp án' : 'Hiện đáp án' }}
              </button>
            </div>
          </div>

          <div *ngIf="q.audioUrl && isListeningQuestion(q)" class="question-audio">
            <label>Audio:</label>
            <audio [src]="q.audioUrl" controls preload="auto"></audio>
          </div>

          <div *ngIf="q.type === 'mcq'" class="options">
            <label *ngFor="let o of q.options" class="option-row">
              <input type="radio" name="q{{q.id}}" [value]="o.id" [(ngModel)]="answers[q.id]" />
              <span class="option-letter">{{ o.id }}.</span>
              <ng-container *ngIf="shouldShowAnswers(q); else hiddenOptionText">
                <span class="option-text">{{ o.text }}</span>
              </ng-container>
              <ng-template #hiddenOptionText>
                <span class="option-text placeholder">[Đang ẩn đáp án]</span>
              </ng-template>
            </label>
          </div>
          <div *ngIf="q.type === 'text' && shouldShowAnswers(q)" class="options">
            <ng-container *ngIf="isSpeakingQuestion(q); else writingQuestion">
  <div class="audio-recorder">
    <button type="button" class="btn" (click)="startRecording(q.id)" [disabled]="isRecording[q.id]">
      {{ isRecording[q.id] ? 'Đang ghi...' : 'Bắt đầu ghi âm' }}
    </button>
    <button type="button" class="btn" (click)="stopRecording(q.id)" [disabled]="!isRecording[q.id]">
      Dừng ghi âm
    </button>
    <div class="record-timer" *ngIf="isRecording[q.id]">
      Thời gian ghi âm: {{ recordingTimeDisplay[q.id] || '00:00' }}
    </div>
    <div class="record-timer" *ngIf="!isRecording[q.id] && recordingTimeDisplay[q.id]">
      Thời gian: {{ recordingTimeDisplay[q.id] }}
    </div>
    <div *ngIf="recordedAudio[q.id]" class="audio-playback">
      <!-- <label>Nghe lại:</label> -->
      <audio [src]="getAudioUrl(q.id)" controls></audio>
    </div>
  </div>
</ng-container>
            <ng-template #writingQuestion>
              <textarea [(ngModel)]="textAnswers[q.id]" name="t{{q.id}}" rows="5" placeholder="Viết câu trả lời của bạn ở đây..."></textarea>
            </ng-template>
          </div>
        </div>
      </div>
    </ng-container>

    <div class="quiz-actions">
      <button type="submit" class="btn btn--primary">{{ submitLabel }}</button>
    </div>
  </form>

  <section *ngIf="quizSubmitted && allowDetailedReview" class="quiz-review">
    <div class="review-header">
      <h4>Kết quả chi tiết</h4>
      <button type="button" class="toggle-review-btn" (click)="toggleReviewVisibility()">
        {{ reviewExpanded ? 'Ẩn kết quả chi tiết' : 'Hiển thị kết quả chi tiết' }}
      </button>
    </div>
    <ng-container *ngIf="reviewExpanded">
      <div class="review-card" *ngFor="let section of quizSections">
        <h5>{{ section.title }}</h5>
        <div class="review-question" *ngFor="let q of section.questions">
        <div class="review-question-header">
          <span class="rq-index">{{ q.id }}.</span>
          <span class="rq-text">{{ q.prompt }}</span>
        </div>
        <div class="review-row">
          <span class="review-label">Đáp án của bạn:</span>
          <span class="review-value">{{ getUserAnswerDisplay(q) }}</span>
        </div>
        <div *ngIf="q.type === 'mcq' && q.options?.length" class="review-options">
          <div
            *ngFor="let o of q.options"
            class="review-option"
            [class.correct]="q.correctOptionId && q.correctOptionId === o.id"
            [class.selected]="answers[q.id] === o.id"
          >
            <span class="opt-letter">{{ o.id }}.</span>
            <span class="opt-text">{{ o.text }}</span>
            <span class="badge" *ngIf="q.correctOptionId === o.id">Đáp án đúng</span>
            <span class="badge badge--secondary" *ngIf="answers[q.id] === o.id">Bạn đã chọn</span>
          </div>
        </div>
        <div class="review-row" *ngIf="q.type === 'mcq' && q.correctOptionId">
          <span class="review-label">Đáp án đúng:</span>
          <span class="review-value">{{ getOptionDisplay(q, q.correctOptionId) }}</span>
        </div>
        <div class="review-row" *ngIf="q.explanation">
          <span class="review-label">Giải thích:</span>
          <span class="review-value">{{ q.explanation }}</span>
        </div>
        </div>
      </div>
    </ng-container>
  </section>
</section>
