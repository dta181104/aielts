<section class="admin-page">
  <app-admin-nav></app-admin-nav>

  <header class="section-header">
    <div>
      <p class="eyebrow">Quản lý khóa học</p>
    </div>
    <button type="button" class="btn-secondary" (click)="startCreate()">Tạo mới</button>
  </header>

  <form class="card filter-bar" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
    <input type="text" formControlName="keyword" placeholder="Tìm kiếm theo tiêu đề..." />
    <select formControlName="status">
      <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
    </select>
    <select formControlName="type">
      <option *ngFor="let option of typeOptions" [value]="option.value">{{ option.label }}</option>
    </select>
    <select formControlName="size" (change)="changePageSize()">
      <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}/trang</option>
    </select>
    <button type="submit" class="btn-primary">Áp dụng</button>
    <button type="button" class="btn-secondary" (click)="resetFilters()">Xoá lọc</button>
  </form>

  <div class="admin-grid">
    <div class="card list-card">
      <div class="card-header">
        <div>
          <h3>Danh sách khóa học</h3>
          <p class="muted">Tổng cộng {{ totalCourses }} khóa học</p>
        </div>
        <span class="badge" *ngIf="loading">Đang tải...</span>
      </div>

      <div *ngIf="feedback" class="alert" [ngClass]="feedback.type">{{ feedback.text }}</div>
      <div *ngIf="errorMessage" class="alert error">{{ errorMessage }}</div>

      <div *ngIf="!loading && courses.length === 0" class="empty">Chưa có khóa học phù hợp.</div>

      <div class="courses-list" *ngIf="courses.length">
        <article *ngFor="let course of courses; trackBy: trackByCourseId" class="course-item">
          <div class="info">
            <img *ngIf="course.thumbnail || course.imageUrl" [src]="course.thumbnail || course.imageUrl" alt="thumbnail" />
            <div>
              <strong>{{ course.title }}</strong>
              <p>{{ course.description || 'Chưa có mô tả' }}</p>
              <div class="meta-row">
                <span class="status-chip" [ngClass]="course.status?.toLowerCase()">{{ getStatusLabel(course.status) }}</span>
                <span class="status-chip secondary">{{ getTypeLabel(course.courseType) }}</span>
                <span class="price" *ngIf="course.price !== undefined">{{ course.price | number }} đ</span>
              </div>
            </div>
          </div>
          <div class="inline-actions">
            <button type="button" (click)="manageQuizzes(course)">Bài quiz</button>
            <button type="button" (click)="editCourse(course)">Sửa</button>
            <button type="button" (click)="deleteCourse(course)" [disabled]="deletingId === course.id">
              {{ deletingId === course.id ? 'Đang xoá...' : 'Xoá' }}
            </button>
          </div>
        </article>
      </div>

      <div class="pagination" *ngIf="pageCount > 1">
        <button type="button" (click)="changePage(-1)" [disabled]="pageIndex === 0 || loading">Trước</button>
        <span>Trang {{ pageIndex + 1 }} / {{ pageCount || 1 }}</span>
        <button type="button" (click)="changePage(1)" [disabled]="pageIndex >= pageCount - 1 || loading">Sau</button>
      </div>
    </div>

    <form class="card form-card" [formGroup]="courseForm" (ngSubmit)="saveCourse()">
      <h3>{{ editingCourse ? 'Chỉnh sửa khóa học' : 'Tạo khóa học mới' }}</h3>
      <div class="form-grid">
        <label>
          <span>Tiêu đề *</span>
          <input type="text" formControlName="title" />
        </label>
        <label>
          <span>Level name</span>
          <input type="text" formControlName="levelName" />
        </label>
        <label>
          <span>Target band</span>
          <input type="number" min="0" max="9" step="0.5" formControlName="targetBand" />
        </label>
        <label>
          <span>Giá (VND)</span>
          <input type="number" min="0" formControlName="price" />
        </label>
        <label>
          <span>Loại khóa học</span>
          <select formControlName="courseType">
            <option value="FULL">Full program</option>
            <option value="SINGLE">Single</option>
            <option value="TIPS">Tips</option>
          </select>
        </label>
        <label>
          <span>Trạng thái</span>
          <select formControlName="status">
            <option value="DRAFT">Nháp</option>
            <option value="PUBLISHED">Published</option>
            <option value="ARCHIVED">Archived</option>
          </select>
        </label>
        <label class="full-width">
          <span>Ảnh bìa (URL)</span>
          <input type="text" formControlName="thumbnail" />
        </label>
        <label class="full-width">
          <span>Mô tả</span>
          <textarea rows="4" formControlName="description"></textarea>
        </label>
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary" [disabled]="saving">
          {{ saving ? 'Đang lưu...' : editingCourse ? 'Cập nhật' : 'Tạo mới' }}
        </button>
        <button type="button" class="btn-secondary" (click)="startCreate()">Làm mới</button>
      </div>
    </form>
  </div>

  <div class="card structure-card" *ngIf="editingCourse">
    <div class="structure-header">
      <div>
        <h3>Cấu trúc khóa học</h3>
        <p class="muted">Quản lý chương & bài học cho "{{ editingCourse.title }}"</p>
      </div>
      <div class="structure-header-actions">
        <span class="badge" *ngIf="loadingSections || loadingLessons">Đang đồng bộ...</span>
        <button type="button" class="btn-secondary" (click)="refreshStructure()">Làm mới</button>
      </div>
    </div>

    <div class="structure-columns">
      <div class="structure-column">
        <h4>Thêm chương</h4>
        <form [formGroup]="sectionForm" (ngSubmit)="saveSection()">
          <label>
            <span>Tiêu đề *</span>
            <input type="text" formControlName="title" />
          </label>
          <label>
            <span>Thứ tự</span>
            <input type="number" min="0" formControlName="orderIndex" />
          </label>
          <div class="actions">
            <button type="submit" class="btn-primary" [disabled]="savingSection">
              {{ savingSection ? 'Đang tạo...' : 'Thêm chương' }}
            </button>
          </div>
        </form>

        <div class="section-list" *ngIf="sections.length; else emptySections">
          <article *ngFor="let section of sections" [class.active]="section.id === selectedSectionId" class="section-item">
            <div>
              <strong>{{ section.title }}</strong>
              <p class="muted">Thứ tự: {{ section.orderIndex ?? '—' }} • {{ section.lessons?.length || 0 }} bài học</p>
            </div>
            <button type="button" (click)="selectSection(section)">Chọn</button>
          </article>
        </div>
        <ng-template #emptySections>
          <p class="empty">Chưa có chương nào cho khóa học này.</p>
        </ng-template>
      </div>

      <div class="structure-column">
        <h4>Thêm bài học</h4>
        <form [formGroup]="lessonForm" (ngSubmit)="saveLesson()">
          <label>
            <span>Chương</span>
            <select formControlName="sectionId">
              <option [ngValue]="null">-- Chọn chương --</option>
              <option *ngFor="let section of sections" [ngValue]="section.id">{{ section.title }}</option>
            </select>
          </label>
          <label>
            <span>Tiêu đề *</span>
            <input type="text" formControlName="title" />
          </label>
          <label>
            <span>Loại bài học</span>
            <select formControlName="type">
              <option *ngFor="let type of lessonTypes" [value]="type">{{ type }}</option>
            </select>
          </label>
          <label>
            <span>Video URL</span>
            <input type="text" formControlName="videoUrl" />
          </label>
          <label>
            <span>Thời lượng (phút)</span>
            <input type="number" min="0" formControlName="duration" />
          </label>
          <label>
            <span>Nội dung</span>
            <textarea rows="3" formControlName="content"></textarea>
          </label>
          <div class="actions">
            <button type="submit" class="btn-primary" [disabled]="savingLesson">
              {{ savingLesson ? 'Đang tạo...' : 'Thêm bài học' }}
            </button>
          </div>
        </form>

        <div class="lesson-list">
          <div *ngIf="loadingLessons" class="alert info">Đang tải bài học...</div>
          <div *ngIf="!loadingLessons && !sectionLessons.length" class="empty">Chưa có bài học nào cho chương này.</div>
          <article class="lesson-item" *ngFor="let lesson of sectionLessons">
            <div>
              <strong>{{ lesson.title }}</strong>
              <p class="muted">Loại: {{ lesson.type }} • Thời lượng: {{ lesson.duration || '—' }} phút</p>
            </div>
          </article>
        </div>
      </div>
    </div>
  </div>
</section>
