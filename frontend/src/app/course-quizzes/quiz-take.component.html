<section class="quiz-take container">
  <div class="header">
    <app-button variant="ghost" (pressed)="onCancel()">← Quay lại</app-button>
    <div class="header-title">
      <h2>{{ selectedQuiz?.title }} <span class="muted">- {{ courseName || 'Khóa học' }}</span></h2>
      <div class="quiz-meta">{{ sectionOrder.length }} phần · Điểm tự chấm gần nhất: {{ quizAutoScore ?? 0 }} / {{ quizAutoTotal }}</div>
    </div>
  </div>

  <div *ngIf="loading" class="state state-loading">Đang tải chi tiết bài kiểm tra...</div>
  <div *ngIf="!loading && error" class="state state-error">{{ error }}</div>

  <div *ngIf="!loading && !error && selectedQuiz">
    <div class="sections-overview">
      <h3>Các phần trong bài thi</h3>
      <ul class="section-list">
        <li *ngFor="let sid of sectionOrder; let i = index" class="section-item">
          <div class="section-info">
            <div class="section-title">{{ sectionMeta[sid]?.title }}</div>
            <div class="section-desc">{{ sectionMeta[sid]?.desc }}</div>
          </div>
          <div class="section-actions">
            <div class="section-time">Thời lượng: {{ sectionMeta[sid]?.minutes ?? 0 }} phút</div>
            <div *ngIf="sectionCompleted[sid]" class="section-status">Hoàn thành</div>
            <div *ngIf="!sectionCompleted[sid] && sectionStarted[sid]" class="section-status">Đang làm — còn: {{ formatTime(sectionRemaining[sid]) }}</div>
            <app-button *ngIf="!sectionStarted[sid] && !sectionCompleted[sid]" variant="primary" (pressed)="startSection(i)">Bắt đầu</app-button>
            <app-button *ngIf="sectionStarted[sid] && !sectionCompleted[sid]" variant="ghost" (pressed)="openSection(i)">Mở</app-button>
            <app-button *ngIf="sectionCompleted[sid]" variant="ghost" (pressed)="openSection(i)">Xem kết quả</app-button>
          </div>
        </li>
      </ul>
    </div>

    <div *ngIf="currentSectionIndex!==null" class="section-container" style="margin-top:16px">
      <h4>{{ sectionMeta[sectionOrder[currentSectionIndex]]?.title }} — Thời gian còn lại: {{ formatTime(sectionRemaining[sectionOrder[currentSectionIndex]]) }}</h4>
      <app-quiz
        [quizSections]="quizSections"
        [answers]="answers"
        [textAnswers]="textAnswers"
        [selectedQuiz]="selectedQuiz"
        [quizSubmitted]="quizSubmitted"
        [quizAutoScore]="quizAutoScore"
        [quizAutoTotal]="quizAutoTotal"
        [allowDetailedReview]="isCurrentSectionDetailedReviewAllowed"
        (cancel)="onCancel()"
        (submitted)="submitSection(currentSectionIndex!)"
        (audioCaptured)="onChildAudioCaptured($event)"
      ></app-quiz>
      <div *ngIf="quizSubmitted" class="result" style="margin-top:12px">
        <ng-container *ngIf="isCurrentSectionAiGraded; else autoResult">
          <ng-container *ngIf="isCurrentSectionWriting; else speakingAi">
            <div style="font-size: 18px; font-weight: 600">Kết quả chấm của AI:</div>
            <div *ngFor="let q of (quizSections[0]?.questions || [])" style="margin-top:16px">
              <div style="font-size:18px; font-weight: 600">*Câu {{ q.id }}:</div>
              <div style="margin-top:6px">
                <strong>Điểm:</strong>
                <ng-container
                  *ngTemplateOutlet="aiScoreValue; context: { score: currentAiByQuestion[q.id]?.score }"
                ></ng-container>
              </div>
              <div *ngIf="currentAiByQuestion[q.id]?.teacherNote" style="margin-top:10px">
                <ng-container
                  *ngTemplateOutlet="aiNote; context: { html: aiMarkdownByQuestion[q.id] }"
                ></ng-container>
              </div>
            </div>
          </ng-container>

          <ng-template #speakingAi>
            <div>
              <span style="font-size: 18px; font-weight: 600">Kết quả chấm từ AI: </span>
              <ng-container *ngTemplateOutlet="aiScoreValue; context: { score: aiGradeScore }"></ng-container>
            </div>
            <div *ngIf="aiTeacherNote" style="margin-top:30px">
              <ng-container *ngTemplateOutlet="aiNote; context: { html: markdownHtml }"></ng-container>
            </div>
          </ng-template>

          <ng-template #aiScoreValue let-score="score">
            <span *ngIf="score !== null && score !== undefined; else pendingAi">
              {{ score | number: '1.1-1' }}
            </span>
            <ng-template #pendingAi>Chưa chấm</ng-template>
          </ng-template>

          <ng-template #aiNote let-html="html">
            <div style="font-weight: 600">Nhận xét:</div>
            <div [innerHTML]="html"></div>
          </ng-template>
        </ng-container>
        <ng-template #autoResult>
          <strong>Kết quả tự chấm phần này:</strong> {{ quizAutoScore }} / {{ quizAutoTotal }}
        </ng-template>
      </div>
    </div>
  </div>
</section>
